<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

    <!--
         See http://wiki.openmrs.org/display/docs/Module+liquibase+File for
         documentation on this file.

         See http://www.liquibase.org/manual/home#available_database_refactorings
         for a list of supported elements and attributes
     -->
    <property name="clob.type" value="longtext"/>

    <changeSet id="html5form-2013-06-11-12:30" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="html5forms_tag" schemaName="openmrs"/>
            </not>
        </preConditions>
        <comment>
            Table for tags
        </comment>
        <createTable tableName="html5forms_tag">
            <column name="html5forms_tag_id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)"/>
        </createTable>
    </changeSet>
    <changeSet id="muzima-20170828-1811" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="html5forms_tag" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE html5forms_tag CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="html5form-2013-06-12-05:30" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="html5forms_form_tag_mapping" schemaName="openmrs"/>
            </not>
        </preConditions>
        <comment>
            Table for tags to form mapping
        </comment>
        <createTable tableName="html5forms_form_tag_mapping">
            <column name="form_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="tag_id" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="form_id,tag_id" constraintName="html5forms_form_tag_mapping_form_id_pk"
                       tableName="html5forms_form_tag_mapping"/>
    </changeSet>

    <changeSet id="muzima-20170828-1813" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="html5forms_form_tag_mapping" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE html5forms_form_tag_mapping CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="html5form-2013-06-13-07:15" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="html5forms_form" schemaName="openmrs"/>
            </not>
        </preConditions>
        <comment>
            Table for forms
        </comment>
        <createTable tableName="html5forms_form">
            <column name="form_id" type="int">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="form_id" constraintName="html5forms_form_id_pk" tableName="html5forms_form"/>
    </changeSet>

    <changeSet id="muzima-20170828-1814" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="html5forms_form" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE html5forms_form CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="html5form-2013-06-25-18:15" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="html5forms_form" columnName="model"/>
                <columnExists tableName="html5forms_form" columnName="form"/>
            </not>
        </preConditions>
        <comment>
            adding new columns to html5forms
        </comment>
        <addColumn tableName="html5forms_form">
            <column name="model" type="text"></column>
        </addColumn>
        <addColumn tableName="html5forms_form">
            <column name="form" type="text"></column>
        </addColumn>
    </changeSet>

    <changeSet id="html5form-2013-07-1-18:15" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="html5forms_form" columnName="form"/>
            <columnExists tableName="html5forms_form" columnName="model"/>
        </preConditions>
        <comment>
            removing columns
        </comment>
        <dropColumn columnName="form" tableName="html5forms_form"/>
        <dropColumn columnName="model" tableName="html5forms_form"/>
    </changeSet>

    <changeSet id="html5form-2013-07-1-20:15" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="html5forms_form" columnName="form"/>
                <columnExists tableName="html5forms_form" columnName="model"/>
            </not>
        </preConditions>
        <comment>
            adding new columns to html5forms
        </comment>
        <addColumn tableName="html5forms_form"> <column name="model" type="${clob.type}"></column> </addColumn>
        <addColumn tableName="html5forms_form"> <column name="form" type="${clob.type}"></column>  </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-12:00" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzimaforms_form"/>
                <tableExists tableName="muzimaforms_tag"/>
                <tableExists tableName="muzimaforms_tag_map"/>
            </not>
            <and>
                <tableExists tableName="html5forms_form"/>
                <tableExists tableName="html5forms_tag"/>
                <tableExists tableName="html5forms_form_tag_mapping"/>
            </and>
        </preConditions>
        <comment>
            renames tables - prefix html5 to muzima
        </comment>

        <renameTable oldTableName="html5forms_form" newTableName="muzimaforms_form"/>
        <renameTable oldTableName="html5forms_tag" newTableName="muzimaforms_tag"/>
        <renameTable oldTableName="html5forms_form_tag_mapping" newTableName="muzimaforms_tag_map"/>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-16:30" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaforms_tag"/>
                <tableExists tableName="muzimaforms_form"/>
            </and>
            <and>
                <columnExists tableName="muzimaforms_tag" columnName="html5forms_tag_id"/>
                <columnExists tableName="muzimaforms_form" columnName="model"/>
                <columnExists tableName="muzimaforms_form" columnName="form"/>
            </and>
        </preConditions>
        <comment>
            renaming old columns in html5forms
        </comment>
        <renameColumn tableName="muzimaforms_tag" oldColumnName="html5forms_tag_id" newColumnName="muzimaforms_tag_id" columnDataType="int"/>
        <renameColumn tableName="muzimaforms_form" oldColumnName="model" newColumnName="model_xml" columnDataType="${clob.type}"/>
        <renameColumn tableName="muzimaforms_form" oldColumnName="form" newColumnName="form_html" columnDataType="${clob.type}"/>
    </changeSet>

    <changeSet id="html5form-2019-07-29-10:10" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzimaforms_form" columnName="model_json"/>
            </not>
        </preConditions>
        <comment>
            adding new column to html5forms
        </comment>
        <addColumn tableName="muzimaforms_form"> <column name="model_json" type="${clob.type}"></column> </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-18:00" author="ThoughtWorks">
        <preConditions>
            <tableExists tableName="muzimaforms_tag"/>
        </preConditions>
        <comment>
            renaming columns removed autoincrement - fixing that
        </comment>
        <dropColumn tableName="muzimaforms_tag" columnName="muzimaforms_tag_id"/>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-18:30" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzimaforms_tag" columnName="muzimaforms_tag_id"/>
            </not>
        </preConditions>
        <comment>
            adding back columns removed autoincrement - fixing that
        </comment>
        <addColumn tableName="muzimaforms_tag">
            <column name="muzimaforms_tag_id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
        </addColumn>

    </changeSet>
    <!--Removed changeset to add back constraintName unique-tag-name added previously-->
    <changeSet id="muzimaform-2013-07-10-20:00" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaforms_form"/>
            </and>
            <not>
                <columnExists tableName="muzimaforms_form" columnName="creator"/>
                <columnExists tableName="muzimaforms_form" columnName="date_created"/>
                <columnExists tableName="muzimaforms_form" columnName="changed_by"/>
                <columnExists tableName="muzimaforms_form" columnName="date_changed"/>
                <columnExists tableName="muzimaforms_form" columnName="retired"/>
                <columnExists tableName="muzimaforms_form" columnName="date_retired"/>
                <columnExists tableName="muzimaforms_form" columnName="retire_reason"/>
            </not>
        </preConditions>
        <comment>
            adding muzimaforms_form audit columns
        </comment>
        <addColumn tableName="muzimaforms_form">
            <column name="creator" valueNumeric="1" type="int"/>
            <column name="date_created" valueDate="2007-05-04" type="date"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="date"/>
            <column name="retired" valueBoolean="false" type="boolean"/>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="date"/>
            <column name="retire_reason" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-21:00" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaforms_tag"/>
            </and>
            <not>
                <columnExists tableName="muzimaforms_tag" columnName="creator"/>
                <columnExists tableName="muzimaforms_tag" columnName="date_created"/>
                <columnExists tableName="muzimaforms_tag" columnName="changed_by"/>
                <columnExists tableName="muzimaforms_tag" columnName="date_changed"/>
                <columnExists tableName="muzimaforms_tag" columnName="retired"/>
                <columnExists tableName="muzimaforms_tag" columnName="date_retired"/>
                <columnExists tableName="muzimaforms_tag" columnName="retire_reason"/>
            </not>
        </preConditions>
        <comment>
            adding muzimaforms_tag audit columns
        </comment>
        <addColumn tableName="muzimaforms_tag">
            <column name="creator" valueNumeric="1" type="int"/>
            <column name="date_created" valueDate="2007-05-04" type="date"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="date"/>
            <column name="retired" valueBoolean="false" type="boolean"/>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="date"/>
            <column name="retire_reason" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-07-10-22:00" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaforms_tag_map"/>
            </and>
            <not>
                <columnExists tableName="muzimaforms_tag_map" columnName="creator"/>
                <columnExists tableName="muzimaforms_tag_map" columnName="date_created"/>
                <columnExists tableName="muzimaforms_tag_map" columnName="changed_by"/>
                <columnExists tableName="muzimaforms_tag_map" columnName="date_changed"/>
                <columnExists tableName="muzimaforms_tag_map" columnName="retired"/>
                <columnExists tableName="muzimaforms_tag_map" columnName="date_retired"/>
                <columnExists tableName="muzimaforms_tag_map" columnName="retire_reason"/>
            </not>
        </preConditions>
        <comment>
            adding muzimaforms_tag_map audit columns
        </comment>
        <addColumn tableName="muzimaforms_tag_map">
            <column name="creator" valueNumeric="1" type="int"/>
            <column name="date_created" valueDate="2007-05-04" type="date"/>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="date"/>
            <column name="retired" valueBoolean="false" type="boolean"/>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="date"/>
            <column name="retire_reason" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-07-15-16:30" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaforms_form"/>
                <tableExists tableName="muzimaforms_tag"/>
            </and>
            <not>
                <columnExists tableName="muzimaforms_form" columnName="uuid"/>
                <columnExists tableName="muzimaforms_tag" columnName="uuid"/>
            </not>
        </preConditions>
        <comment>
            adding unique constraint
        </comment>
        <addColumn tableName="muzimaforms_form"> <column name="uuid" type="char(38)"/></addColumn>
        <addColumn tableName="muzimaforms_tag"> <column name="uuid" type="char(38)"/> </addColumn>

        <addUniqueConstraint constraintName="unique-muzimaforms-form-uuid" tableName="muzimaforms_form" columnNames="uuid"/>
        <addUniqueConstraint constraintName="unique-muzimaforms-tag-uuid" tableName="muzimaforms_tag" columnNames="uuid"/>
    </changeSet>

    <changeSet id="muzimaform-2013-08-20-16:40" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaforms_form"/>
            </and>
            <not>
                <columnExists tableName="muzimaforms_form" columnName="name"/>
                <columnExists tableName="muzimaforms_tag" columnName="description"/>
            </not>
        </preConditions>
        <comment>
            Adding the name and description columns
        </comment>
        <addColumn tableName="muzimaforms_form"> <column name="name" type="varchar(255)"/> </addColumn>
        <addColumn tableName="muzimaforms_form"> <column name="description" type="varchar(255)"/> </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2013-08-20-17:08" author="ThoughtWorks" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzimaforms_form" columnName="name"/>
                <columnExists tableName="muzimaforms_form" columnName="description"/>
            </and>
        </preConditions>
        <comment>
            Migrating already imported form names and descriptions
        </comment>
        <sql>
            UPDATE
            muzimaforms_form mform
            JOIN form form ON mform.form_id = form.form_id
            SET
            mform.name = form.name,
            mform.description = form.description
        </sql>
    </changeSet>

    <changeSet id="muzimaform-2013-12-01-09:30" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzimaforms_form" columnName="retired"/>
                <columnExists tableName="muzimaforms_tag" columnName="retired"/>
                <columnExists tableName="muzimaforms_tag_map" columnName="retired"/>
            </and>
        </preConditions>
        <comment>
            Adding default values for boolean columns in muzimaforms_form related tables
        </comment>
        <addDefaultValue tableName="muzimaforms_form" columnName="retired" defaultValueBoolean="false"/>
        <addDefaultValue tableName="muzimaforms_tag" columnName="retired" defaultValueBoolean="false"/>
        <addDefaultValue tableName="muzimaforms_tag_map" columnName="retired" defaultValueBoolean="false"/>
    </changeSet>

    <changeSet id="muzimaform-2013-12-02-09:30" author="ThoughtWorks">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzimaforms_form" columnName="retired"/>
                <columnExists tableName="muzimaforms_tag" columnName="retired"/>
                <columnExists tableName="muzimaforms_tag_map" columnName="retired"/>
            </and>
        </preConditions>
        <comment>
            Adding default values for the existing records in muzimaforms_form related tables
        </comment>
        <update tableName="muzimaforms_form"> <column name="retired" valueBoolean="false"/>
            <where>
                retired is null
            </where>
        </update>
        <update tableName="muzimaforms_tag"> <column name="retired" valueBoolean="false"/>
            <where>
                retired is null
            </where>
        </update>
        <update tableName="muzimaforms_tag_map"> <column name="retired" valueBoolean="false"/>
            <where>
                retired is null
            </where>
        </update>
    </changeSet>

    <changeSet id="muzimaform-2014-06-29-22:55" author="nribeka" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzimaforms_form" columnName="discriminator"/>
            </not>
        </preConditions>
        <comment>
            Adding the discriminator column
        </comment>
        <addColumn tableName="muzimaforms_form">
            <column name="discriminator" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2014-07-14-21:36" author="nribeka" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzimaforms_form" columnName="form"/>
            </not>
        </preConditions>
        <comment>
            Adding the form relation to resolve the encounter type.
        </comment>
        <addColumn tableName="muzimaforms_form">
            <column name="form" type="char(38)"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzimaform-2014-10-16" author="SahajSoft">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzimaforms_form" columnName="version"/>
            </not>
        </preConditions>
        <comment>
            Adding version column
        </comment>
        <addColumn tableName="muzimaforms_form"> <column name="version" type="varchar(255)"/> </addColumn>
    </changeSet>

    <changeSet id="muzima-20180706-1247" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzimaforms_form" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzimaforms_form CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="muzimaform-2019-08-07" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaforms_form" schemaName="openmrs"/>
                <not>
                    <foreignKeyConstraintExists foreignKeyName="fk_muzimaforms_form_openmrs_form"/>
                </not>
            </and>
        </preConditions>
        <comment>
            Add  muzimaforms_form Foreign Key Constraint
        </comment>
        <!-- add the new constraints-->
        <addForeignKeyConstraint baseColumnNames="form"
                                 baseTableName="muzimaforms_form"
                                 constraintName="fk_muzimaforms_form_openmrs_form"
                                 referencedColumnNames="uuid"
                                 referencedTableName="form"/>
    </changeSet>

    <changeSet author="shwetha" id="muzimaform-2014-10-17" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzimaforms_form" columnName="name"/>
                <columnExists tableName="muzimaforms_form" columnName="description"/>
                <columnExists tableName="muzimaforms_form" columnName="version"/>
            </and>
        </preConditions>
        <dropColumn columnName="name" tableName="muzimaforms_form"/>
        <dropColumn columnName="description" tableName="muzimaforms_form"/>
        <dropColumn columnName="version" tableName="muzimaforms_form"/>
    </changeSet>

    <changeSet id="muzima-2013-04-18-10-50" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_data_source"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_data_source">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_data_source_creator"
                                 baseTableName="muzima_data_source" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_data_source_changed_by"
                                 baseTableName="muzima_data_source" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_data_source_retired_by"
                                 baseTableName="muzima_data_source" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20170828-1942" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_data_source" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzima_data_source CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="muzima-2013-04-18-10-51" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_queue_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_queue_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="discriminator" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data_source" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="mediumtext">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_queue_data_creator"
                                 baseTableName="muzima_queue_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_queue_data_changed_by"
                                 baseTableName="muzima_queue_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_queue_data_data_source"
                                 baseTableName="muzima_queue_data" baseColumnNames="data_source"
                                 referencedTableName="muzima_data_source" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="muzima-20170828-1943" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_queue_data" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzima_queue_data CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>
    <changeSet id="muzima-2013-04-18-10-52" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_archive_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_archive_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="discriminator" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data_source" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="mediumtext">
                <constraints nullable="false"/>
            </column>
            <column name="message" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="date_archived" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_archive_data_creator"
                                 baseTableName="muzima_archive_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_archive_data_changed_by"
                                 baseTableName="muzima_archive_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_archive_data_data_source"
                                 baseTableName="muzima_archive_data" baseColumnNames="data_source"
                                 referencedTableName="muzima_data_source" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="muzima-20170828-1944" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_archive_data" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzima_archive_data CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="muzima-2013-04-18-10-53" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_error_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_error_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="discriminator" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="data_source" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="mediumtext">
                <constraints nullable="false"/>
            </column>
            <column name="message" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="date_processed" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_error_data_creator"
                                 baseTableName="muzima_error_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_error_data_changed_by"
                                 baseTableName="muzima_error_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_error_data_data_source"
                                 baseTableName="muzima_error_data" baseColumnNames="data_source"
                                 referencedTableName="muzima_data_source" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="muzima-20170828-1945" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_error_data" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzima_error_data CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="muzima-2013-04-18-10-54" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_notification_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_notification_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="subject" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="receiver" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="sender" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="patient" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="voided" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_notification_data_creator"
                                 baseTableName="muzima_notification_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_notification_data_changed_by"
                                 baseTableName="muzima_notification_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_notification_data_voided_by"
                                 baseTableName="muzima_notification_data" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_notification_data_sender"
                                 baseTableName="muzima_notification_data" baseColumnNames="sender"
                                 referencedTableName="person" referencedColumnNames="person_id"/>
        <addForeignKeyConstraint constraintName="muzima_notification_data_receiver"
                                 baseTableName="muzima_notification_data" baseColumnNames="receiver"
                                 referencedTableName="person" referencedColumnNames="person_id"/>
    </changeSet>

    <changeSet id="muzima-20170828-1947" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_notification_data" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzima_notification_data CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>
    <changeSet id="nribeka" author="muzima-2014-02-04-07-10-54">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <columnExists tableName="muzima_notification_data" columnName="status"/>
                </not>
                <not>
                    <columnExists tableName="muzima_notification_data" columnName="source"/>
                </not>
            </and>
        </preConditions>
        <addColumn tableName="muzima_notification_data">
            <column name="status" type="varchar(50)"> <constraints nullable="false"/> </column>
            <column name="source" type="varchar(50)"> <constraints nullable="false"/> </column>
        </addColumn>
    </changeSet>
    <changeSet id="muzima-20140312-110700" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <changeSetExecuted id="nribeka" author="muzima-2014-02-04-07-10-54" changeLogFile="liquibase.xml"/>
        </preConditions>
        <delete tableName="liquibasechangelog">
            <where>id='nribeka' and author='muzima-2014-02-04-07-10-54'</where>
        </delete>
    </changeSet>

    <changeSet id="muzima-20140312-110800" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_notification_data" columnName="status"/>
                <columnExists tableName="muzima_notification_data" columnName="source"/>
            </and>
        </preConditions>
        <dropColumn tableName="muzima_notification_data" columnName="status"/>
        <dropColumn tableName="muzima_notification_data" columnName="source"/>
    </changeSet>

    <changeSet id="muzima-20140312-110900" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <columnExists tableName="muzima_notification_data" columnName="status"/>
                </not>
                <not>
                    <columnExists tableName="muzima_notification_data" columnName="source"/>
                </not>
            </and>
        </preConditions>
        <addColumn tableName="muzima_notification_data">  <column name="status" type="varchar(50)"> <constraints nullable="false"/> </column>
            <column name="source" type="varchar(50)"> <constraints nullable="false"/> </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20140312-111000" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_notification_data" columnName="role"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_notification_data">
            <column name="role" type="varchar(255)"> <constraints nullable="true"/> </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_notification_data_role"
                                 baseTableName="muzima_notification_data" baseColumnNames="role"
                                 referencedTableName="role" referencedColumnNames="role"/>
    </changeSet>

    <changeSet id="muzima-20140312-111100" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="muzima_notification_data" columnName="receiver"/>
        </preConditions>
        <dropNotNullConstraint tableName="muzima_notification_data" columnName="receiver" columnDataType="int"/>
    </changeSet>

    <changeSet id="muzima-2015-03-30-4:00pm" author="Vikas">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_error_message"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_error_message">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="muzima_error_data_id" type="int">
            </column>
            <column name="message" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_error_message_creator"
                                 baseTableName="muzima_error_message" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_error_message_changed_by"
                                 baseTableName="muzima_error_message" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_error_message_data"
                                 baseTableName="muzima_error_message" baseColumnNames="muzima_error_data_id"
                                 referencedTableName="muzima_error_data" referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="muzima-20170828-1948" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_error_message" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzima_error_message CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>
    <changeSet id="muzima-20150819-111000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_queue_data" columnName="location_id"/>
                <columnExists tableName="muzima_queue_data" columnName="location_name"/>
                <columnExists tableName="muzima_queue_data" columnName="provider_id"/>
                <columnExists tableName="muzima_queue_data" columnName="provider_name"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_queue_data">
            <column name="location_id" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_queue_data">
            <column name="location_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_queue_data">
            <column name="provider_id" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_queue_data">
            <column name="provider_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20150820-112000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_error_data" columnName="location_id"/>
                <columnExists tableName="muzima_error_data" columnName="location_name"/>
                <columnExists tableName="muzima_error_data" columnName="provider_id"/>
                <columnExists tableName="muzima_error_data" columnName="provider_name"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_error_data">
            <column name="location_id" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_error_data">
            <column name="location_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_error_data">
            <column name="provider_id" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="muzima_error_data">
            <column name="provider_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20150825-113000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_queue_data" columnName="form_name"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_queue_data">
            <column name="form_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20150825-114000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_error_data" columnName="form_name"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_error_data">
            <column name="form_name" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20150909-113000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_queue_data" columnName="location_id"/>
                <columnExists tableName="muzima_queue_data" columnName="location_name"/>
                <not>
                    <columnExists tableName="muzima_queue_data" columnName="location"/>
                </not>
            </and>
        </preConditions>
        <dropColumn tableName="muzima_queue_data" columnName="location_id"/>
        <dropColumn tableName="muzima_queue_data" columnName="location_name"/>
        <addColumn tableName="muzima_queue_data"> <column name="location" type="int"> <constraints nullable="true"/> </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_queue_data_location"
                                 baseTableName="muzima_queue_data" baseColumnNames="location"
                                 referencedTableName="location" referencedColumnNames="location_id"/>
    </changeSet>

    <changeSet id="muzima-20150909-114000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_error_data" columnName="location_id"/>
                <columnExists tableName="muzima_error_data" columnName="location_name"/>
            </and>
            <not>
                <columnExists tableName="muzima_error_data" columnName="location"/>
            </not>
        </preConditions>
        <dropColumn tableName="muzima_error_data" columnName="location_id"/>
        <dropColumn tableName="muzima_error_data" columnName="location_name"/>
        <addColumn tableName="muzima_error_data"> <column name="location" type="int"> <constraints nullable="true"/> </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_error_data_location"
                                 baseTableName="muzima_error_data" baseColumnNames="location"
                                 referencedTableName="location" referencedColumnNames="location_id"/>
    </changeSet>

    <changeSet id="muzima-20150910-113000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_queue_data" columnName="provider_id"/>
                <columnExists tableName="muzima_queue_data" columnName="provider_name"/>
            </and>
            <not>
                <columnExists tableName="muzima_queue_data" columnName="provider"/>
            </not>
        </preConditions>
        <dropColumn tableName="muzima_queue_data" columnName="provider_id"/>
        <dropColumn tableName="muzima_queue_data" columnName="provider_name"/>
        <addColumn tableName="muzima_queue_data"> <column name="provider" type="int"> <constraints nullable="true"/> </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_queue_data_provider"
                                 baseTableName="muzima_queue_data" baseColumnNames="provider"
                                 referencedTableName="provider" referencedColumnNames="provider_id"/>
    </changeSet>

    <changeSet id="muzima-20150910-114000" author="shwetha">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_error_data" columnName="provider_id"/>
                <columnExists tableName="muzima_error_data" columnName="provider_name"/>
            </and>
            <not>
                <columnExists tableName="muzima_error_data" columnName="provider"/>
            </not>
        </preConditions>
        <dropColumn tableName="muzima_error_data" columnName="provider_id"/>
        <dropColumn tableName="muzima_error_data" columnName="provider_name"/>
        <addColumn tableName="muzima_error_data"> <column name="provider" type="int"> <constraints nullable="true"/> </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_error_data_provider"
                                 baseTableName="muzima_error_data" baseColumnNames="provider"
                                 referencedTableName="provider" referencedColumnNames="provider_id"/>
    </changeSet>

    <changeSet id="muzima-2015-10-05-11:45am" author="VNAGARAJAN">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_error_data" columnName="patientUuid"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_error_data"> <column name="patientUuid" type="varchar(255)"> <constraints nullable="false"/> </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-2015-10-05-12:00pm" author="VNAGARAJAN">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_queue_data" columnName="patientUuid"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_queue_data"> <column name="patientUuid" type="varchar(255)"> <constraints nullable="false"/> </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-2015-10-05-11:31am" author="VNAGARAJAN">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_archive_data" columnName="patientUuid"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_archive_data"> <column name="patientUuid" type="varchar(255)"> <constraints nullable="false"/> </column>
        </addColumn>
    </changeSet>
    <changeSet author="mssavai" id="muzima-20151102-105200">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzima_error_data"/>
                <columnExists tableName="muzima_error_data" columnName="patientUuid"/>
                <not>
                    <columnExists tableName="muzima_error_data" columnName="patient_uuid"/>
                </not>
            </and>
        </preConditions>
        <comment>
            Renaming patientUuid to patient_uuid
        </comment>
        <renameColumn  tableName="muzima_error_data"
                       oldColumnName="patientUuid"
                       newColumnName="patient_uuid"
                       columnDataType="varchar(255)" />
    </changeSet>
    <changeSet author="mssavai" id="muzima-20151102-105300">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzima_queue_data"/>
                <columnExists tableName="muzima_queue_data" columnName="patientUuid"/>

                <not>
                    <columnExists tableName="muzima_queue_data" columnName="patient_uuid"/>
                </not>
            </and>
        </preConditions>
        <comment>
            Renaming patientUuid to patient_uuid
        </comment>
        <renameColumn    tableName="muzima_queue_data"
                         oldColumnName="patientUuid"
                         newColumnName="patient_uuid"
                         columnDataType="varchar(255)" />
    </changeSet>
    <changeSet author="mssavai" id="muzima-20151102-105400">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzima_archive_data"/>
                <columnExists tableName="muzima_archive_data" columnName="patientUuid"/>

                <not>
                    <columnExists tableName="muzima_archive_data" columnName="patient_uuid"/>
                </not>
            </and>
        </preConditions>
        <comment>
            Renaming patientUuid to patient_uuid
        </comment>
        <renameColumn tableName="muzima_archive_data"
                      oldColumnName="patientUuid"
                      newColumnName="patient_uuid"
                      columnDataType="varchar(255)" />
    </changeSet>

    <changeSet id="smbugua" author="muzima-2015-10-15-20-13-12">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_notification_data" columnName="patient"/>
            </not>
        </preConditions>
        <addColumn tableName="muzima_notification_data">
            <column name="patient" type="int">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="muzima_notification_patient"
                                 baseTableName="muzima_notification_data" baseColumnNames="patient"
                                 referencedTableName="patient" referencedColumnNames="patient_id"/>
    </changeSet>

    <changeSet id="muzimaregistration-2013-06-18-09-20" author="nribeka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzimaregistration_registration_data"/>
            </not>
        </preConditions>
        <createTable tableName="muzimaregistration_registration_data">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="temporary_uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="assigned_uuid" type="char(38)">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>

            <column name="voided" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzimaregistration_registration_data_creator"
                                 baseTableName="muzimaregistration_registration_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzimaregistration_registration_data_changed_by"
                                 baseTableName="muzimaregistration_registration_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzimaregistration_registration_data_voided_by"
                                 baseTableName="muzimaregistration_registration_data" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>
    <changeSet id="muzima-20170828-1949" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzimaregistration_registration_data" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzimaregistration_registration_data CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="muzima-20190808-095338" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaforms_form" schemaName="openmrs"/>
                <tableExists tableName="muzimaforms_form" schemaName="openmrs"/>
                <tableExists tableName="muzimaforms_tag_map" schemaName="openmrs"/>
                <not>
                    <tableExists tableName="muzima_form" schemaName="openmrs"/>
                    <tableExists tableName="muzima_form_tag" schemaName="openmrs"/>
                    <tableExists tableName="muzima_form_tag_map" schemaName="openmrs"/>

                    <foreignKeyConstraintExists foreignKeyName="muzima_form_openmrs_form"/>

                </not>
            </and>
        </preConditions>
        <comment>
            Renames tables - prefix muzimaform to muzima and rename columns and constraints appropriately
        </comment>

        <!--rename the tables-->
        <renameTable oldTableName="muzimaforms_form" newTableName="muzima_form"/>
        <renameTable oldTableName="muzimaforms_tag" newTableName="muzima_form_tag"/>
        <renameTable oldTableName="muzimaforms_tag_map" newTableName="muzima_form_tag_map"/>

        <!--Finally add the new constraints-->
        <addForeignKeyConstraint constraintName="muzima_form_openmrs_form" baseTableName="muzima_form" baseColumnNames="form"
                                 referencedTableName="form" referencedColumnNames="uuid"/>
        <addUniqueConstraint constraintName="unique-muzima-form-uuid" tableName="muzima_form" columnNames="uuid"/>
        <addUniqueConstraint constraintName="unique-muzima-form-tag-uuid" tableName="muzima_form_tag" columnNames="uuid"/>
        <addUniqueConstraint constraintName="unique-muzima-form-tag-name" tableName="muzima_form_tag" columnNames="name"/>
    </changeSet>

    <changeSet id="muzima-20160901-094022" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzimaregistration_registration_data"/>
                <not>
                    <tableExists tableName="muzima_registration_data"/>
                </not>
            </and>
        </preConditions>

        <comment>
            Renames tables and indices - prefix muzimaregistration to muzima
        </comment>

        <!--First drop the existing constraints on this table-->
        <dropForeignKeyConstraint baseTableName="muzimaregistration_registration_data" constraintName="muzimaregistration_registration_data_creator"/>
        <dropForeignKeyConstraint baseTableName="muzimaregistration_registration_data" constraintName="muzimaregistration_registration_data_changed_by"/>
        <dropForeignKeyConstraint baseTableName="muzimaregistration_registration_data" constraintName="muzimaregistration_registration_data_voided_by"/>

        <!--Then rename the table-->
        <renameTable oldTableName="muzimaregistration_registration_data" newTableName="muzima_registration_data"/>

        <!--Finally add the new constraints-->
        <addForeignKeyConstraint constraintName="muzima_registration_data_creator" baseTableName="muzima_registration_data" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_registration_data_changed_by" baseTableName="muzima_registration_data" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_registration_data_voided_by" baseTableName="muzima_registration_data" baseColumnNames="voided_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20190806-150052" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_form_tag" columnName="muzimaforms_tag_id"/>
            </and>
        </preConditions>
        <comment>
            Rename primary key in table muzima_form_tag using raw sql since renameColumn loses autoIncrement feature
        </comment>
        <sql>
            ALTER TABLE `muzima_form_tag`
            CHANGE COLUMN `muzimaforms_tag_id` `muzima_form_tag_id`  int NOT NULL AUTO_INCREMENT FIRST
        </sql>
    </changeSet>

    <changeSet id="muzima-20160915154129" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_config"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_config">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
            <column name="config_json" type="${clob.type}"/>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_config_creator"
                                 baseTableName="muzima_config" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_config_changed_by"
                                 baseTableName="muzima_config" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_config_retired_by"
                                 baseTableName="muzima_config" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20170828-1950" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_config" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzima_config CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="muzima-20190808-101052" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzima_form"/>
                <not>
                    <columnExists tableName="muzima_form" columnName="meta_json"/>
                </not>
            </and>
        </preConditions>

        <comment>
            Add column metadata to store metadata as a json blob
        </comment>

        <addColumn tableName="muzima_form"> <column name="meta_json" type="${clob.type}"/> </addColumn>
    </changeSet>
    <changeSet id="muzima-20170912151100" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_setting"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_setting">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="property" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar(255)"/>
            <column name="description" type="varchar(1024)"/>
            <column name="value_boolean" type="tinyint"/>
            <column name="value_string" type="varchar(255)"/>
            <column name="setting_data_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_setting_creator"
                                 baseTableName="muzima_setting" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_setting_changed_by"
                                 baseTableName="muzima_setting" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_setting_retired_by"
                                 baseTableName="muzima_setting" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>
    <changeSet id="muzima-20190404-1046" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_setting" schemaName="openmrs"/>
        </preConditions>
        <comment>
            change charset to utf-8
        </comment>
        <sql>
            ALTER TABLE muzima_setting CONVERT TO CHARACTER SET utf8
        </sql>
    </changeSet>

    <changeSet id="muzima-20190813185600" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='2a277ceb-7f23-4cc0-9e9b-1686985df121'</sqlCheck>
        </preConditions>
        <insert tableName="muzima_setting">
            <column name="property" value="PatientIdentifier.AutoGeneration" />
            <column name="name" value="Patient Identifier auto-generation" />
            <column name="description" value="Defines whether or not patient patient identifier should be autogenerated during processing mUzima registration data. This should be set to 'true' if autogeneration is needed" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2017-09-22T00:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="2a277ceb-7f23-4cc0-9e9b-1686985df121" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190813185700" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='aae1a60f-f6ac-4d00-8af7-80270d715114'</sqlCheck>
        </preConditions>
        <insert tableName="muzima_setting">
            <column name="property" value="PatientIdentifier.AutoGenerationSourceName" />
            <column name="name" value="Patient Identifier auto-generation Source name" />
            <column name="description" value="Specifies name of auto-generation source defined in ID-GEN module" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2017-10-17T00:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="aae1a60f-f6ac-4d00-8af7-80270d715114" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190813185800" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_data_source` WHERE `uuid` ='0d62b128-010e-4c1b-ba86-ef963b7f8a72'</sqlCheck>
        </preConditions>
        <comment>Creating a default mUzima data source with the name Mobile Devices</comment>
        <insert tableName="muzima_data_source">
            <column name="name" value="Mobile Devices"/>
            <column name="description" value="Default data source"/>
            <column name="creator" value="1"/>
            <column name="date_created" valueDate="2018-02-14T10:00:00"/>
            <column name="uuid" value="0d62b128-010e-4c1b-ba86-ef963b7f8a72"/>
        </insert>
    </changeSet>

    <!--Inserting Muzima Queue Data Processor into schedule_task_config table-->
    <changeSet id="${project.parent.artifactId}-20180802-1220" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrCharts.task.RefreshETLTablesTask'
                And name = 'Refresh ETL Tables'
            </sqlCheck>
        </preConditions>
        <comment>Inserting Muzima Queue Data Processor into 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Muzima Queue Data Processor" />
            <column name="description" value="Processes Muzima Queue Data Processor" />
            <column name="schedulable_class" value="org.openmrs.module.muzima.task.ProcessQueueDataTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2017-11-28T23:59:59" />
            <column name="repeat_interval" value="180" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="1" />
            <column name="uuid" value="b82736c2-9651-11e8-9eb6-529269fb1459" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190807172200" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_notification_data" columnName="patient"/>
            </and>
            <sqlCheck expectedResult="1">
                SELECT
                CASE WHEN EXISTS(
                SELECT count(*)
                FROM  INFORMATION_SCHEMA.COLUMNS
                WHERE table_name='muzima_notification_data'
                AND column_name='patient'
                AND IS_NULLABLE='NO'
                GROUP by table_name
                HAVING count(*) > 1 )
                then 1
                else 0
                end
            </sqlCheck>
        </preConditions>
        <dropNotNullConstraint columnDataType="int" columnName="patient" tableName="muzima_notification_data"/>
    </changeSet>

    <changeSet id="muzima-20180621154129" author="dileka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_cohort_report_config"/>
            </not>
            <and>
                <tableExists tableName="reporting_report_design"/>
            </and>

        </preConditions>
        <createTable tableName="muzima_cohort_report_config">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_uuid" type="char(38)">
                <constraints nullable="false"/>
            </column>
            <column name="report_design_uuid" type="char(38)">
                <constraints nullable="false"/>

            </column>
            <column name="priority" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>

            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int" />
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="muzima_cohort_report_config_creator"
                                 baseTableName="muzima_cohort_report_config" baseColumnNames="creator"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_report_config_changed_by"
                                 baseTableName="muzima_cohort_report_config" baseColumnNames="changed_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
        <addForeignKeyConstraint constraintName="muzima_cohort_report_config_retired_by"
                                 baseTableName="muzima_cohort_report_config" baseColumnNames="retired_by"
                                 referencedTableName="users" referencedColumnNames="user_id"/>
    </changeSet>

    <changeSet id="muzima-20180630154129" author="dileka">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="muzima_generated_report"/>
            </not>
        </preConditions>
        <createTable tableName="muzima_generated_report">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_report_config_id" type="int">
            </column>

            <column name="report_request_uuid" type="char(38)">
                <constraints nullable="false"/>
            </column>

            <column name="status" type="varchar(255)"/>

            <column name="patient_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="report_json" type="longblob">

            </column>
            <column name="priority" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>

            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int" />
            <column name="date_changed" type="datetime"/>
            <column name="retired" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="retired_by" type="int"/>
            <column name="date_retired" type="datetime"/>
            <column name="retire_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="muzima-20180626154129" author="dileka" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config where schedulable_class =
                'org.openmrs.module.muzima.task.GeneratePatientReportsTask'
            </sqlCheck>
        </preConditions>
        <comment>Add GeneratePatientReportsTask to scheduler</comment>
        <sql>
            INSERT INTO  scheduler_task_config  (name, description, schedulable_class,
            start_time, start_time_pattern, repeat_interval, start_on_startup, started,
            created_by, date_created, changed_by, date_changed, last_execution_time, uuid )
            VALUES ('Auto Generate Patient Reports', 'Generates patient reports for specified cohort report mappings', 'org.openmrs.module.muzima.task.GeneratePatientReportsTask',
            '2018-06-26 00:00:00','MM/dd/yyyy HH:mm:ss',86400, 1, 1,
            1, now(), NULL, NULL, NULL, uuid());
        </sql>
    </changeSet>

    <changeSet id="muzima-20190813265900" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='24caa622-691a-493b-b9ac-8ee70424ad47'</sqlCheck>
        </preConditions>
        <comment>Specifies Concept Uuid for Complex Obs Audio Content</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="AudioContentComplexObs.ConceptUuid" />
            <column name="name" value="Concept Uuid for Complex Obs Audio Content" />
            <column name="description" value="Specifies Concept Uuid for Complex Obs Audio Content" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-07-17T11:56:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="24caa622-691a-493b-b9ac-8ee70424ad47" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190814312000" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='eaf882a3-3360-45b3-b480-ee9e634bc74f'</sqlCheck>
        </preConditions>
        <comment>Specifies Concept Uuid for Complex Obs Video Content</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="VideoContentComplexObs.ConceptUuid" />
            <column name="name" value="Concept Uuid for Complex Obs Video Content" />
            <column name="description" value="Specifies Concept Uuid for Complex Obs Video Content" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-07-17T12:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="eaf882a3-3360-45b3-b480-ee9e634bc74f" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190814342200" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='fd759595-6338-491b-ac37-62e699c1823c'</sqlCheck>
        </preConditions>
        <comment>Specifies Concept Uuid for Complex Obs Image Content</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="ImageContentComplexObs.ConceptUuid" />
            <column name="name" value="Concept Uuid for Complex Obs Image Content" />
            <column name="description" value="Specifies Concept Uuid for Complex Obs Image Content" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-07-17T12:02:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="fd759595-6338-491b-ac37-62e699c1823c" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190814352400" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='651fc189-127f-4b4c-98f3-121ed5ad182e'</sqlCheck>
        </preConditions>
        <comment>Specifies Concept Uuid for for Complex Obs File Content</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="FileContentComplexObs.ConceptUuid" />
            <column name="name" value="Concept Uuid for Complex Obs File Content" />
            <column name="description" value="Specifies Concept Uuid for Complex Obs File Content" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-07-17T12:07:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="651fc189-127f-4b4c-98f3-121ed5ad182e" />
        </insert>
    </changeSet>
    <changeSet id="expandedcohort-2015-03-19-15:50" author="msavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="expanded_cohort_definition"/>
            </not>
        </preConditions>
        <comment>
            Creating the expanded cohort table
        </comment>
        <createTable tableName="expanded_cohort_definition">
            <column name="id" type="int"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_id" type="int"/>
            <column name="sql_definition" type="text"/>
            <column name="is_scheduled" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="creator" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="changed_by" type="int"/>
            <column name="date_changed" type="datetime"/>
            <column name="voided" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="voided_by" type="int"/>
            <column name="date_voided" type="datetime"/>
            <column name="void_reason" type="varchar(255)" defaultValue="null"/>
            <column name="uuid" type="char(38)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="expandedcohort-2018-07-20-13:14" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="expanded_cohort_update_history"/>
            </not>
        </preConditions>
        <comment>
            Creating the expanded cohort update history table
        </comment>
        <createTable tableName="expanded_cohort_update_history">
            <column name="id" type="int"  autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cohort_id" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="members_added" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="date_updated" type="datetime">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="expandedcohort-2018-08-25-15:52" author="mssavai" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="expanded_cohort_update_history" columnName="members_removed"/>
            </not>
        </preConditions>
        <comment>
            Adding the members_removed column
        </comment>
        <addColumn tableName="expanded_cohort_update_history">
            <column name="members_removed" type="text"/>
        </addColumn>
    </changeSet>
    <changeSet id="expandedcohort-2018-08-25-16:35" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="expanded_cohort_update_history" columnName="members_added"/>
        </preConditions>
        <comment>
            Dropping null constraint on members_added column
        </comment>
        <dropNotNullConstraint tableName="expanded_cohort_update_history"
                               columnName="members_added"
                               columnDataType="text"/>
    </changeSet>
    <changeSet id="expandedcohort-2018-08-27-13:12" author="mssavai" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="expanded_cohort_definition" columnName="enable_member_addition"/>
            </not>
        </preConditions>
        <comment>
            Adding the enable_member_addition column
        </comment>
        <addColumn tableName="expanded_cohort_definition">
            <column name="enable_member_addition" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="expandedcohort-2018-08-27-13:16" author="mssavai" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="expanded_cohort_definition" columnName="enable_member_removal"/>
            </not>
        </preConditions>
        <comment>
            Adding the enable_member_removal column
        </comment>
        <addColumn tableName="expanded_cohort_definition">
            <column name="enable_member_removal" type="tinyint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20190708143800" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='25e52b76-dbef-4629-aed2-5497a1f8303c'</sqlCheck>
        </preConditions>
        <comment>Specifies if smart card feature will be enabled on Android App</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="SHRStatus.isEnabled" />
            <column name="name" value="SHR status" />
            <column name="description" value="Specifies if smart card feature will be enabled on Android App" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-08-31T00:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="25e52b76-dbef-4629-aed2-5497a1f8303c" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190708144000" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='7c5f3458-c240-11e8-a355-529269fb145i'</sqlCheck>
        </preConditions>
        <comment>Specifies if GPS tracking feature will be activated on mUzima mobile application</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="GPSStatus.isEnabled" />
            <column name="name" value="GPS status" />
            <column name="description" value="Specifies if GPS tracking feature will be activated on mUzima mobile application" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2018-09-27T00:00:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="7c5f3458-c240-11e8-a355-529269fb145i" />
        </insert>

    </changeSet>

    <changeSet id="muzima-20190708144100" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='b7c0c988-3047-11e9-873e-d0577bcb2fe6'</sqlCheck>
        </preConditions>
        <comment>Specifies Concept-Uuid for convenient set concept that wraps media complex obs with its metadata</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="MediaWrapperConcept.ConceptUuid" />
            <column name="name" value="Uuid for Media Wrapper Concept" />
            <column name="description" value="Specifies Concept-Uuid for convenient set concept that wraps media complex obs with its metadata" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-02-14T13:53:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="b7c0c988-3047-11e9-873e-d0577bcb2fe6" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190708142100" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='f81e3970-3047-11e9-873e-d0577bcb2fe6'</sqlCheck>
        </preConditions>
        <comment>Specifies Concept-Uuid for concept-set other non-coded option for media category</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="MediaCategoryOtherNonCoded.ConceptUuid" />
            <column name="name" value="Concept Uuid for other non-coded category" />
            <column name="description" value="Specifies Concept-Uuid for concept-set other non-coded option for media category" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-02-14T13:56:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="f81e3970-3047-11e9-873e-d0577bcb2fe6" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190708146100" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='235e34e6-3048-11e9-873e-d0577bcb2fe6'</sqlCheck>
        </preConditions>
        <comment>Specifies Concept-Uuid for media comment concept</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="MediaContentComment.ConceptUuid" />
            <column name="name" value="Concept Uuid for Media Content Comment" />
            <column name="description" value="Specifies Concept-Uuid for media comment concept" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-02-14T14:03:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="235e34e6-3048-11e9-873e-d0577bcb2fe6" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190708148100" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='adbda0a4-34d5-11e9-8667-d0577bcb2fe6'</sqlCheck>
        </preConditions>
        <comment>Specifies Concept-Uuid for free text for other-non coded category option</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="MediaCategoryFreeText.ConceptUuid" />
            <column name="name" value="Concept Uuid for Other category text" />
            <column name="description" value="Specifies Concept-Uuid for free text for other-non coded category option" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-02-20T10:30:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="adbda0a4-34d5-11e9-8667-d0577bcb2fe6" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20190808172200" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_archive_data" columnName="patientUuid"/>
            </and>
            <sqlCheck expectedResult="1">
                SELECT
                CASE WHEN EXISTS(
                SELECT count(*)
                FROM  INFORMATION_SCHEMA.COLUMNS
                WHERE table_name='muzima_archive_data'
                AND column_name='patientUuid'
                AND IS_NULLABLE='NO'
                GROUP by table_name
                HAVING count(*) > 0 )
                then 1
                else 0
                end
            </sqlCheck>
        </preConditions>
        <dropNotNullConstraint columnDataType="varchar(255)" columnName="patientUuid" tableName="muzima_archive_data"/>
    </changeSet>

    <changeSet id="muzima-20190808173000" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_queue_data" columnName="patientUuid"/>
            </and>
            <sqlCheck expectedResult="1">
                SELECT
                CASE WHEN EXISTS(
                SELECT count(*)
                FROM  INFORMATION_SCHEMA.COLUMNS
                WHERE table_name='muzima_queue_data'
                AND column_name='patientUuid'
                AND IS_NULLABLE='NO'
                GROUP by table_name
                HAVING count(*) > 0 )
                then 1
                else 0
                end
            </sqlCheck>
        </preConditions>
        <dropNotNullConstraint columnDataType="varchar(255)" columnName="patientUuid" tableName="muzima_queue_data"/>
    </changeSet>

    <changeSet id="muzima-20190808173600" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_error_data" columnName="patientUuid"/>
            </and>
            <sqlCheck expectedResult="1">
                SELECT
                CASE WHEN EXISTS(
                SELECT count(*)
                FROM  INFORMATION_SCHEMA.COLUMNS
                WHERE table_name='muzima_error_data'
                AND column_name='patientUuid'
                AND IS_NULLABLE='NO'
                GROUP by table_name
                HAVING count(*) > 0 )
                then 1
                else 0
                end
            </sqlCheck>
        </preConditions>
        <dropNotNullConstraint columnDataType="varchar(255)" columnName="patientUuid" tableName="muzima_error_data"/>
    </changeSet>

    <changeSet id="muzima-20190430114100" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="muzima_cohort_report_config" columnName="report_design_uuid"/>
            </and>
        </preConditions>
        <comment>
            changing type for report_design column in muzima_cohort_report_config table
        </comment>

        <renameColumn tableName="muzima_cohort_report_config" oldColumnName="report_design_uuid" newColumnName="report_designs"
                      columnDataType="${clob.type}"/>
    </changeSet>

    <changeSet id="muzima-20190503023107" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="muzima_generated_report" schemaName="openmrs"/>
                <not>
                    <tableExists tableName="muzima_patient_report" schemaName="openmrs"/>
                </not>
            </and>
        </preConditions>
        <comment>
            renames tables - patient reports
        </comment>

        <renameTable oldTableName="muzima_generated_report" newTableName="muzima_patient_report"/>
    </changeSet>

    <changeSet id="muzima-20190503023643" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_patient_report" columnName="name"/>
            </not>
        </preConditions>
        <comment>
            add name column to the patient reports table
        </comment>
        <addColumn tableName="muzima_patient_report">
            <column name="name" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20190822212731" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="muzima_setting"/>
        </preConditions>
        <comment>
            Modify muzima setting for Patient Reports
        </comment>
        <update tableName="muzima_setting">
            <column name="setting_data_type" value="BOOLEAN"/>
            <column name="property" value="PatientReport.isEnabled"/>
            <column name="name" value="Patient Report Download Status"/>
            <column name="description" value="Whether patient reports will be downloaded to mobile device"/>
            <where>uuid = 'aae1a60f-f6ac-4d00-ffff-80270d715114'</where>
        </update>
    </changeSet>

    <changeSet id="muzima-20190418094500" author="bmokaya">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from `muzima_setting` WHERE `uuid` ='0080ecb8-61a6-11e9-a5ac-d0577bcb2fe6'</sqlCheck>
        </preConditions>
        <comment>
            Modify muzima setting for Concept Uuid for the title of the media
        </comment>
        <insert tableName="muzima_setting">
            <column name="property" value="MediaTitle.ConceptUuid" />
            <column name="name" value="Concept Uuid for the title of the media" />
            <column name="description" value="Specifies Concept-Uuid for the title of the media uploaded" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-04-18T09:45:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="0080ecb8-61a6-11e9-a5ac-d0577bcb2fe6" />
        </insert>
    </changeSet>

    <changeSet id="muzima-201909041456" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_queue_data" columnName="form_data_uuid"/>
            </not>
        </preConditions>
        <comment>
            Adding the form_data_uuid column to muzima_queue_data table
        </comment>
        <addColumn tableName="muzima_queue_data">
            <column name="form_data_uuid" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-201909041500" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_error_data" columnName="form_data_uuid"/>
            </not>
        </preConditions>
        <comment>
            Adding the form_data_uuid column to muzima_error_data table
        </comment>
        <addColumn tableName="muzima_error_data">
            <column name="form_data_uuid" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-201909041505" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="muzima_archive_data" columnName="form_data_uuid"/>
            </not>
        </preConditions>
        <comment>
            Adding the form_data_uuid column to muzima_archive_data table
        </comment>
        <addColumn tableName="muzima_archive_data">
            <column name="form_data_uuid" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="muzima-20190829172700" author="smbugua">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = 'f8c4ea54-9e8f-4f47-86c1-ab52f0bc719f';
            </sqlCheck>
        </preConditions>
        <comment>Add Relationships Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="Relationships.isEnabled"/>
            <column name="name" value="Relationships status" />
            <column name="description" value="Specifies if Relationships feature will be enabled for this implementation" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-08-29T17:27:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="f8c4ea54-9e8f-4f47-86c1-ab52f0bc719f" />
        </insert>

    </changeSet>

    <changeSet id="muzima-20191117190900" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = 'f268a5cf-5583-4e8a-9704-20f638732021';
            </sqlCheck>
        </preConditions>
        <comment>Add Event Logging Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="Logging.isEnabled"/>
            <column name="name" value="Event Logging status" />
            <column name="description" value="Specifies whether Event Logging feature will be enabled for this implementation" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-11-17T19:09:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="f268a5cf-5583-4e8a-9704-20f638732021" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191117191200" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '5e75dd1e-ae43-4e3c-8860-bb7fcc1d79ff';
            </sqlCheck>
        </preConditions>
        <comment>Add Event Logs server URL Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="LogServer.url"/>
            <column name="name" value="Event Logs server URL" />
            <column name="description" value="Specifies the URL of the Server where event logs should be transmitted" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-11-17T19:12:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="5e75dd1e-ae43-4e3c-8860-bb7fcc1d79ff" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191117191800" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '6babf927-e531-4119-8369-2981133d836c';
            </sqlCheck>
        </preConditions>
        <comment>Add Event Logs server Connection key Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="LogServer.connectionKey"/>
            <column name="name" value="Event Logs server Connection Key" />
            <column name="description" value="Specifies the Connection Key for use while transmitting logs to the Logs server" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-11-17T19:18:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="6babf927-e531-4119-8369-2981133d836c" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191203163000" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '35a658af-cdfa-4ac4-ac35-a1e40e1def0d';
            </sqlCheck>
        </preConditions>
        <comment>Add Setting for enabling Geomapping feature</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="LoggingDeidentification.isEnabled"/>
            <column name="name" value="Logging Deidentification status" />
            <column name="description" value="Specifies whether Deidentification of logging information will be done for this implementation" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-12-03T16:30:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="35a658af-cdfa-4ac4-ac35-a1e40e1def0d" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191203155800" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '3933439b-cc1e-46a8-abb2-6d3587d1baf0';
            </sqlCheck>
        </preConditions>
        <comment>Add Setting for enabling Geomapping feature</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="GeoMapping.isEnabled"/>
            <column name="name" value="Geomapping feature status" />
            <column name="description" value="Specifies whether Geomapping feature will be enabled for this implementation" />
            <column name="setting_data_type" value="BOOLEAN" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-12-03T15:58:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="3933439b-cc1e-46a8-abb2-6d3587d1baf0" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191203164100" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = '0309dfba-a66b-4b03-a10b-5ca8ed37ff70';
            </sqlCheck>
        </preConditions>
        <comment>Add maps key setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="MapsApi.key"/>
            <column name="name" value="Maps API Key" />
            <column name="description" value="Specifies the Key for accessing maps services" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-12-03T16:41:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="0309dfba-a66b-4b03-a10b-5ca8ed37ff70" />
        </insert>
    </changeSet>

    <changeSet id="muzima-20191128132500" author="mssavai">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM muzima_setting where uuid = 'eb780e26-30a0-4e53-b3da-a3f56f13ccde';
            </sqlCheck>
        </preConditions>
        <comment>Add Event Logs server Connection key Setting</comment>
        <insert tableName="muzima_setting">
            <column name="property" value="Encounter.maxDownloadSize"/>
            <column name="name" value="Maximum number of Encounters downloaded per patient" />
            <column name="description" value="Specifies the maximum number of encounters to be downloaded into mUzima per patient" />
            <column name="setting_data_type" value="STRING" />
            <column name="value_boolean" valueBoolean="false" />
            <column name="date_created" valueDate="2019-11-27T13:25:00" />
            <column name="creator" value="1" />
            <column name="uuid" value="eb780e26-30a0-4e53-b3da-a3f56f13ccde" />
        </insert>
    </changeSet>


</databaseChangeLog>
